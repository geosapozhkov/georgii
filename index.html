<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Georgii</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    @font-face {
      font-family: 'Booklet';
      src: url('https://raw.githubusercontent.com/geosapozhkov/georgii/main/BookletSans-regular-trial.otf') format('opentype');
      font-weight: normal;
      font-style: normal;
    }
    body {
      background: #fafafa;
      font-family: 'Booklet', sans-serif;
      color: #1f1f1f;
    }
    .folder-icon {
      position: relative;
      width: 100%;
      height: 96px;
      border-radius: 8px;
      background-color: #e5e7eb; /* основное тело */
    }
    .folder-icon::before {
      content: '';
      position: absolute;
      top: 0;
      left: 10%;
      width: 40%;
      height: 22px;
      background-color: #d1d5db; /* вкладка */
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
    }
  </style>
</head>
<body class="p-6">
  <header class="max-w-6xl mx-auto mb-10 text-center">
    <h1 class="text-4xl font-bold mb-2 tracking-tight">Georgii</h1>
  </header>

  <main class="max-w-6xl mx-auto">
    <nav id="breadcrumb" class="mb-6 text-sm text-gray-500 flex flex-wrap gap-2"></nav>
    <div id="file-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"></div>
    <div id="loading" class="text-center text-gray-400 mt-10">Loading...</div>
  </main>

  <!-- Модальное окно для предпросмотра -->
  <div id="previewModal" class="fixed inset-0 hidden items-center justify-center preview-backdrop z-50">
    <div class="bg-white rounded-2xl p-4 max-w-5xl w-full max-h-[90vh] overflow-auto relative">
      <button id="closePreview" class="absolute top-2 right-2 px-3 py-1 border rounded bg-white">Закрыть</button>
      <div id="previewContent" class="flex justify-center items-center"></div>
      <div id="previewTitle" class="text-center mt-2 font-semibold text-gray-700"></div>
    </div>
  </div>

  <script>
    const publicKey = 'https://disk.yandex.ru/d/n0510qzdIEj3TA';
    const grid = document.getElementById('file-grid');
    const loading = document.getElementById('loading');
    const breadcrumb = document.getElementById('breadcrumb');
    const modal = document.getElementById('previewModal');
    const previewContent = document.getElementById('previewContent');
    const previewTitle = document.getElementById('previewTitle');
    const closePreview = document.getElementById('closePreview');

    closePreview.onclick = () => {
      modal.classList.add('hidden');
      previewContent.innerHTML = '';
    };

    let currentPath = '';

    function isImage(mimeType, name) {
      const ext = name.toLowerCase();
      return (mimeType && mimeType.startsWith('image/')) ||
             ['.jpg', '.jpeg', '.png', '.gif', '.webp'].some(suf => ext.endsWith(suf));
    }
    function isVideo(mimeType, name) {
      const ext = name.toLowerCase();
      return (mimeType && mimeType.startsWith('video/')) ||
             ['.mp4', '.mov', '.avi', '.mkv', '.webm'].some(suf => ext.endsWith(suf));
    }

    async function fetchFolder(path = '') {
      loading.style.display = 'block';
      grid.innerHTML = '';

      const metaUrl =
        `https://cloud-api.yandex.net/v1/disk/public/resources?public_key=${encodeURIComponent(publicKey)}`
        + (path ? `&path=${encodeURIComponent(path)}` : '')
        + '&preview_size=XL&preview_crop=true&limit=1000';

      const res = await fetch(metaUrl);
      const data = await res.json();

      if (!data || data.error) {
        loading.textContent = 'Ошибка загрузки данных.';
        return;
      }

      currentPath = data.path;
      renderBreadcrumb(data.path);
      const items = data._embedded?.items || [];

      if (!items.length) {
        grid.innerHTML = '<div class="col-span-full text-center text-gray-400 border border-dashed rounded-lg p-6">Пусто</div>';
        loading.style.display = 'none';
        return;
      }

      for (const item of items) {
        // Папки
        if (item.type === 'dir') {
          const folderElem = document.createElement('div');
          folderElem.className = 'cursor-pointer';
          folderElem.innerHTML =
            '<div class="folder-icon"></div>';
          folderElem.onclick = () => fetchFolder(item.path);
          grid.appendChild(folderElem);
          continue;
        }

        // Фильтруем по изображениям и видео
        const img = isImage(item.mime_type, item.name);
        const vid = isVideo(item.mime_type, item.name);
        if (!img && !vid) continue;

        // Получаем ссылку на файл через download API
        const dlUrl = `https://cloud-api.yandex.net/v1/disk/public/resources/download?public_key=${encodeURIComponent(publicKey)}&path=${encodeURIComponent(item.path)}`;
        const dlRes = await fetch(dlUrl);
        const dlData = await dlRes.json();
        const href = dlData.href;

        // создаём плитку
        const fileElem = document.createElement('div');
        fileElem.className = 'cursor-pointer';

        // определяем превью
        let previewSrc = item.preview || href;

        // изображения / GIF
        if (img) {
          fileElem.innerHTML =
            `<img src="${previewSrc}" alt="" class="w-full h-48 object-cover rounded-lg">`;
        }
        // видео: статичное превью или заглушка
        else if (vid) {
          if (item.preview) {
            fileElem.innerHTML = `
              <div class="relative">
                <img src="${previewSrc}" alt="" class="w-full h-48 object-cover rounded-lg">
                <div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-30">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                </div>
              </div>`;
          } else {
            fileElem.innerHTML = `
              <div class="relative bg-gray-200 rounded-lg w-full h-48 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-gray-500" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
              </div>`;
          }
        }

        fileElem.onclick = (e) => {
          e.stopPropagation();
          modal.classList.remove('hidden');
          previewTitle.textContent = '';
          if (img) {
            previewContent.innerHTML =
              `<img src="${href}" class="max-h-[80vh] object-contain rounded">`;
          } else if (vid) {
            // Без autoplay: пользователь сам запускает проигрывание
            previewContent.innerHTML =
              `<video controls class="max-h-[80vh] rounded">
                 <source src="${href}" type="${item.mime_type || 'video/mp4'}">
                 Ваш браузер не поддерживает видео.
               </video>`;
          }
        };

        grid.appendChild(fileElem);
      }

      loading.style.display = 'none';
    }

    function renderBreadcrumb(path) {
      breadcrumb.innerHTML = '';
      const parts = path.replace('disk:/', '').split('/').filter(Boolean);
      const crumbs = [{ name: 'Home', path: '' }];
      let cumulative = '';
      for (const part of parts) {
        cumulative += '/' + part;
        crumbs.push({ name: capitalize(part), path: cumulative });
      }
      crumbs.forEach((c, i) => {
        const link = document.createElement('button');
        link.className = 'hover:underline';
        link.textContent = c.name;
        link.onclick = () => fetchFolder(c.path);
        breadcrumb.appendChild(link);
        if (i < crumbs.length - 1) breadcrumb.append(' / ');
      });
    }

    function capitalize(text) {
      return text.charAt(0).toUpperCase() + text.slice(1);
    }

    // Загружаем корневую папку при старте
    fetchFolder();
  </script>
</body>
</html>
