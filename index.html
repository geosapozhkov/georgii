<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>georgii</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    @font-face {
      font-family: 'Booklet';
      src: url('https://raw.githubusercontent.com/geosapozhkov/georgii/main/BookletSans-regular-trial.otf') format('opentype');
      font-weight: normal;
      font-style: normal;
    }
    body {
      background: #fafafa;
      font-family: 'Booklet', sans-serif;
      color: #1f1f1f;
    }
    .file-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .preview-backdrop { background: rgba(0,0,0,0.6); }
  </style>
</head>
<body class="p-6">
  <header class="max-w-6xl mx-auto mb-10 text-center">
    <h1 class="text-4xl font-bold mb-2 tracking-tight">georgii</h1>
  </header>

  <main class="max-w-6xl mx-auto">
    <nav id="breadcrumb" class="mb-6 text-sm text-gray-500 flex flex-wrap gap-2"></nav>
    <div id="file-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"></div>
    <div id="loading" class="text-center text-gray-400 mt-10">Loading...</div>
  </main>

  <footer class="max-w-6xl mx-auto text-center text-sm text-gray-400 mt-10">
    © 2025 georgii
  </footer>

  <!-- Модальное окно для предпросмотра -->
  <div id="previewModal" class="fixed inset-0 hidden items-center justify-center preview-backdrop z-50">
    <div class="bg-white rounded-2xl p-4 max-w-5xl w-full max-h-[90vh] overflow-auto relative">
      <button id="closePreview" class="absolute top-2 right-2 px-3 py-1 border rounded bg-white">Закрыть</button>
      <div id="previewContent" class="flex justify-center items-center"></div>
      <div id="previewTitle" class="text-center mt-2 font-semibold text-gray-700"></div>
    </div>
  </div>

  <script>
    const publicKey = 'https://disk.yandex.ru/d/n0510qzdIEj3TA';
    const grid = document.getElementById('file-grid');
    const loading = document.getElementById('loading');
    const breadcrumb = document.getElementById('breadcrumb');
    const modal = document.getElementById('previewModal');
    const previewContent = document.getElementById('previewContent');
    const previewTitle = document.getElementById('previewTitle');
    const closePreview = document.getElementById('closePreview');

    let currentPath = '';

    closePreview.onclick = () => {
      modal.classList.add('hidden');
      previewContent.innerHTML = '';
    };

    async function fetchFolder(path = '') {
      loading.style.display = 'block';
      grid.innerHTML = '';

      const metaUrl = `https://cloud-api.yandex.net/v1/disk/public/resources?public_key=${encodeURIComponent(publicKey)}${path ? `&path=${encodeURIComponent(path)}` : ''}`;
      const res = await fetch(metaUrl);
      const data = await res.json();

      if (!data || data.error) {
        loading.textContent = 'Ошибка загрузки данных.';
        return;
      }

      currentPath = data.path;
      renderBreadcrumb(data.path);
      const items = data._embedded?.items || [];
      grid.innerHTML = '';

      if (!items.length) {
        grid.innerHTML = '<div class="col-span-full text-center text-gray-400 border border-dashed rounded-lg p-6">Пусто</div>';
        loading.style.display = 'none';
        return;
      }

      for (const item of items) {
        const card = document.createElement('div');
        card.className = 'file-card bg-white rounded-xl p-4 border flex flex-col cursor-pointer transition hover:scale-[1.02]';

        if (item.type === 'dir') {
          card.innerHTML = `
            <div class="text-lg font-semibold mb-1">${item.name}</div>
            <div class="text-xs text-gray-400">папка</div>
          `;
          card.onclick = () => fetchFolder(item.path);
        } else {
          const dlUrl = `https://cloud-api.yandex.net/v1/disk/public/resources/download?public_key=${encodeURIComponent(publicKey)}&path=${encodeURIComponent(item.path)}`;
          const dlRes = await fetch(dlUrl);
          const dlData = await dlRes.json();
          const href = dlData.href;

          const isImage = item.mime_type && item.mime_type.startsWith('image/');
          const isVideo = item.mime_type && item.mime_type.startsWith('video/');
          const thumb = item.preview || '';

          card.innerHTML = `
            <div class="font-semibold truncate mb-2">${item.name}</div>
            ${thumb ? `<img src="${thumb}" alt="${item.name}" class="rounded object-cover w-full h-48 mb-2">` : ''}
            <button class="px-3 py-1 border rounded hover:bg-gray-50 w-fit">Открыть</button>
          `;

          const openBtn = card.querySelector('button');
          openBtn.onclick = (e) => {
            e.stopPropagation();
            modal.classList.remove('hidden');
            previewTitle.textContent = item.name;
            if (isImage) {
              previewContent.innerHTML = `<img src="${href}" class="max-h-[80vh] object-contain rounded">`;
            } else if (isVideo) {
              previewContent.innerHTML = `
                <video controls autoplay class="max-h-[80vh] rounded">
                  <source src="${href}" type="${item.mime_type}">
                  Ваш браузер не поддерживает видео.
                </video>
              `;
            } else {
              previewContent.innerHTML = `<a href="${href}" target="_blank" class="text-blue-600 underline">Открыть файл</a>`;
            }
          };
        }
        grid.appendChild(card);
      }

      loading.style.display = 'none';
    }

    function renderBreadcrumb(path) {
      breadcrumb.innerHTML = '';
      const parts = path.replace('disk:/', '').split('/').filter(Boolean);
      const crumbs = [{ name: 'home', path: '' }];
      let cumulative = '';
      for (const part of parts) {
        cumulative += '/' + part;
        crumbs.push({ name: part, path: cumulative });
      }
      crumbs.forEach((c, i) => {
        const link = document.createElement('button');
        link.className = 'hover:underline';
        link.textContent = c.name;
        link.onclick = () => fetchFolder(c.path);
        breadcrumb.appendChild(link);
        if (i < crumbs.length - 1) breadcrumb.append(' / ');
      });
    }

    fetchFolder();
  </script>
</body>
</html>
