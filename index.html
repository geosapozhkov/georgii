<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="referrer" content="no-referrer">
  <title>Georgii</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    @font-face{
      font-family:'Booklet';
      src:url('https://raw.githubusercontent.com/geosapozhkov/georgii/main/BookletSans-regular.woff') format('woff');
      font-weight:normal;font-style:normal;
    }
    body{background:#fafafa;font-family:'Booklet',sans-serif;color:#1f1f1f}
  </style>
</head>
<body class="p-1.5">
  <header class="flex items-start mb-12 px-1.5">
    <h1 id="logo" class="text-4xl font-bold tracking-tight mr-4">Georgii</h1>
    <p id="bio" class="text-gray-600" style="line-height:1;flex-basis:50%;flex-shrink:1;display:none;">
      As a child, I dreamed of becoming an engineer and building big things. Now I’ve grown up and
      create images that can contain anything. I’m fascinated by how a thought can turn into a
      real object that conveys not only style but also meaning. I think that’s why I love
      photography — it helps me discover something new in everything, every day. By thinking and
      feeling, I try to make the world around me a better place.
    </p>
    <nav id="top-nav" class="ml-auto flex space-x-4 whitespace-nowrap flex-shrink-0 text-base text-gray-600">
      <button id="nav-projects" class="hover:opacity-50 cursor-pointer">Projects</button>
      <button id="nav-about" class="hover:opacity-50 cursor-pointer">About me</button>
    </nav>
  </header>

  <main>
    <nav id="breadcrumb" class="mb-6 text-sm text-gray-500 flex flex-wrap gap-2"></nav>
    <div id="file-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"></div>
    <div id="projects-list" class="hidden"></div>
    <div id="loading" class="text-center text-gray-400 mt-10">Loading...</div>
  </main>

  <!-- Фулл-скрин просмотр -->
  <div id="viewerOverlay" class="fixed inset-0 hidden bg-white flex items-center justify-center z-50">
    <div id="viewerContent" class="flex items-center justify-center max-w-full max-h-full w-full h-full"></div>
  </div>

  <script>
    // Один ключ на всё
    const MAIN_KEY = 'https://disk.yandex.ru/d/n0510qzdIEj3TA';
    const LOGO_CONTENT_PATH = '/Logocontent';

    let currentSection = 'home';
    let currentPath = '';
    let galleryImages = [];

    const grid = document.getElementById('file-grid');
    const loading = document.getElementById('loading');
    const breadcrumb = document.getElementById('breadcrumb');
    const viewerOverlay = document.getElementById('viewerOverlay');
    const viewerContent = document.getElementById('viewerContent');

    // Текущие элементы в папке (храним тип и PATH, а не download.href!)
    let currentItems = [];
    let currentIndex = 0;

    // =============== ВСПОМОГАТЕЛЬНОЕ ===============
    const isImage = (mt, n) => (mt && mt.startsWith('image/')) || /\.(jpe?g|png|gif|webp)$/i.test(n);
    const isVideo = (mt, n) => (mt && mt.startsWith('video/')) || /\.(mp4|mov|avi|mkv|webm)$/i.test(n);

    function renderBreadcrumb(path) {
      breadcrumb.innerHTML = '';
      const crumbs = [{ name:'Home', on: () => { currentSection='home'; fetchFolder(''); } }];
      if (currentSection === 'projects') {
        crumbs.push({ name:'Projects', on: () => { currentSection='projects'; fetchFolder('/Projects'); } });
      }
      const parts = path.replace('disk:/','').split('/').filter(Boolean);
      let cumulative = '';
      parts.forEach(p => { cumulative += '/'+p; crumbs.push({ name:p, on: () => fetchFolder(cumulative) }); });

      crumbs.forEach((c,i)=>{
        const b=document.createElement('button'); b.className='hover:underline'; b.textContent=c.name; b.onclick=c.on;
        breadcrumb.appendChild(b); if(i<crumbs.length-1) breadcrumb.append(' / ');
      });
    }

    async function getJson(url, retries=2){
      for(let i=0;i<=retries;i++){
        try{
          const r = await fetch(url, { cache:'no-store' });
          if(!r.ok) throw new Error('HTTP '+r.status);
          return await r.json();
        }catch(e){ if(i===retries) throw e; await new Promise(res=>setTimeout(res, 300*(i+1))); }
      }
    }

    async function freshDownloadHref(path){
      const u = `https://cloud-api.yandex.net/v1/disk/public/resources/download?public_key=${encodeURIComponent(MAIN_KEY)}&path=${encodeURIComponent(path)}`;
      const data = await getJson(u);
      return data.href;
    }

    // =============== ГРИД ПАПКИ ===============
    async function fetchFolder(path=''){
      loading.style.display='block';
      grid.innerHTML='';
      currentPath = path;

      const metaUrl = `https://cloud-api.yandex.net/v1/disk/public/resources?public_key=${encodeURIComponent(MAIN_KEY)}${path?`&path=${encodeURIComponent(path)}`:''}&preview_size=XL&preview_crop=true&limit=1000`;
      const data = await getJson(metaUrl).catch(()=>null);
      if(!data || data.error){ loading.textContent='Ошибка загрузки данных.'; return; }

      renderBreadcrumb(data.path);
      const isRoot = (!path || data.path==='disk:/') && currentSection==='home';
      const items = data._embedded?.items || [];

      const bioEl = document.getElementById('bio');
      if (bioEl) bioEl.style.display = (currentSection==='about' ? 'block' : 'none');

      breadcrumb.style.display = (!isRoot && currentSection!=='about') ? 'flex' : 'none';
      grid.style.display = isRoot ? 'none' : 'grid';

      if(!items.length){
        grid.innerHTML='<div class="col-span-full text-center text-gray-400 border border-dashed rounded-lg p-6">Пусто</div>';
        loading.style.display='none'; return;
      }

      currentItems = [];
      for(const item of items){
        if(item.type==='dir'){
          if(isRoot) continue;
          const folder=document.createElement('div');
          folder.className='cursor-pointer text-gray-800 hover:opacity-50 col-span-full';
          folder.style.fontWeight='700';
          folder.style.marginTop='0.5rem';
          folder.style.marginBottom='0.25rem';
          const logoEl=document.getElementById('logo');
          folder.style.fontSize = logoEl ? getComputedStyle(logoEl).fontSize : '2.25rem';
          folder.textContent=item.name; // сохраняем подчёркивания
          folder.onclick=()=>fetchFolder(item.path);
          grid.appendChild(folder);
          continue;
        }

        const img = isImage(item.mime_type,item.name);
        const vid = isVideo(item.mime_type,item.name);
        if(!img && !vid) continue;

        // Стабильное превью
        const preview = item.preview || '';
        const wrap = document.createElement('div');
        wrap.className='cursor-pointer';

        if(img){
          wrap.innerHTML = `<img referrerpolicy="no-referrer" src="${preview}" alt="" style="width:100%;max-height:12rem;object-fit:contain;">`;
        }else if(vid){
          if(preview){
            wrap.innerHTML = `
              <div class="relative">
                <img referrerpolicy="no-referrer" src="${preview}" alt="" style="width:100%;max-height:12rem;object-fit:contain;">
                <div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-30">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                </div>
              </div>`;
          }else{
            wrap.innerHTML = `
              <div class="relative bg-gray-200 w-full flex items-center justify-center" style="max-height:12rem;">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-gray-500" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
              </div>`;
          }
        }

        // Сохраняем только PATH и тип, без download.href (он протухает)
        const idx = currentItems.push({ path: item.path, type: img ? 'image' : 'video', mime: item.mime_type || 'video/mp4' }) - 1;
        wrap.onclick = (e)=>{ e.stopPropagation(); openViewer(idx); };
        grid.appendChild(wrap);
      }

      loading.style.display='none';
    }

    // =============== ПРОСМОТРЩИК ===============
    async function openViewer(index){
      currentIndex=index;
      viewerOverlay.classList.remove('hidden');
      document.addEventListener('keydown', handleViewerKey);
      await renderViewer();
    }

    async function renderViewer(){
      const item=currentItems[currentIndex]; if(!item) return;
      viewerContent.innerHTML='';

      // Берём свежий download.href только сейчас
      let href; try{ href = await freshDownloadHref(item.path); }catch(e){ href=''; }

      if(item.type==='image'){
        const img=document.createElement('img');
        img.referrerPolicy='no-referrer';
        img.src=href;
        img.style.maxWidth='70%';
        img.style.maxHeight='70%';
        img.style.objectFit='contain';
        viewerContent.appendChild(img);
      }else{
        const v=document.createElement('video');
        v.controls=true; v.autoplay=true;
        v.src=href; v.type=item.mime; v.crossOrigin='anonymous'; v.referrerPolicy='no-referrer';
        v.style.width='70%'; v.style.height='70%'; v.style.objectFit='contain';
        viewerContent.appendChild(v);
      }
    }

    function closeViewer(){
      viewerOverlay.classList.add('hidden');
      viewerContent.innerHTML='';
      document.removeEventListener('keydown', handleViewerKey);
    }
    function handleViewerKey(e){
      if(e.key==='Escape') closeViewer();
      else if(e.key==='ArrowRight' && currentIndex<currentItems.length-1){ currentIndex++; renderViewer(); }
      else if(e.key==='ArrowLeft' && currentIndex>0){ currentIndex--; renderViewer(); }
    }
    viewerOverlay.addEventListener('click',(e)=>{ if(e.target===viewerOverlay) closeViewer(); });

    // =============== АНИМАЦИЯ ЛОГО (прежняя логика сохранена) ===============
    let logoOverlay=null, logoAnimRAF=null, logoInterval=null;
    function startLogoAnimation(){
      if(logoOverlay || currentSection!=='home') return;
      if(galleryImages.length===0){ preloadLogoGallery(); return; }

      logoOverlay=document.createElement('div');
      logoOverlay.style.position='fixed';
      let headerBottom=0;
      const h=document.querySelector('header');
      if(h){ headerBottom=h.getBoundingClientRect().bottom; logoOverlay.style.top=`${headerBottom}px`; } else { logoOverlay.style.top='0px'; }
      const styles=getComputedStyle(document.body);
      logoOverlay.style.left=styles.paddingLeft; logoOverlay.style.right=styles.paddingRight;
      const footer=document.querySelector('footer'); const fh=footer?footer.getBoundingClientRect().height:0;
      const avail=innerHeight-headerBottom-fh; logoOverlay.style.height= (avail>0? `${avail}px` : '40vh');
      logoOverlay.style.pointerEvents='none'; logoOverlay.style.zIndex='9999'; logoOverlay.style.overflow='hidden';
      document.body.appendChild(logoOverlay);

      const img=document.createElement('img'); img.style.position='absolute'; logoOverlay.appendChild(img);
      const bounce={x:0,y:0,w:0,h:0,dx:(Math.random()*2+1)*0.25*(Math.random()<.5?-1:1),dy:(Math.random()*2+1)*0.25*(Math.random()<.5?-1:1)};
      let idx=0;
      function loadNext(){
        const src=galleryImages[idx]; idx=(idx+1)%galleryImages.length;
        img.onload=()=>{ const mw=logoOverlay.clientWidth*.4, mh=logoOverlay.clientHeight*.4;
          let w=img.naturalWidth*2, h=img.naturalHeight*2; const s=Math.min(mw/w,mh/h,1); w*=s; h*=s;
          bounce.w=w; bounce.h=h; img.style.width=w+'px'; img.style.height=h+'px';
          const maxX=logoOverlay.clientWidth-bounce.w, maxY=logoOverlay.clientHeight-bounce.h;
          if(bounce.x>maxX) bounce.x=maxX; if(bounce.y>maxY) bounce.y=maxY;
          img.style.transform=`translate(${bounce.x}px,${bounce.y}px)`;
        };
        img.src=src;
      }
      loadNext(); logoInterval=setInterval(loadNext, 4000);
      (function anim(){ const w=logoOverlay.clientWidth, h=logoOverlay.clientHeight;
        bounce.x+=bounce.dx; bounce.y+=bounce.dy;
        if(bounce.x<=0||bounce.x+bounce.w>=w) bounce.dx*=-1;
        if(bounce.y<=0||bounce.y+bounce.h>=h) bounce.dy*=-1;
        if(bounce.x<0) bounce.x=0; if(bounce.y<0) bounce.y=0;
        if(bounce.x+bounce.w>w) bounce.x=w-bounce.w; if(bounce.y+bounce.h>h) bounce.y=h-bounce.h;
        img.style.transform=`translate(${bounce.x}px,${bounce.y}px)`;
        logoAnimRAF=requestAnimationFrame(anim);
      })();
    }
    function stopLogoAnimation(){
      if(logoInterval){ clearInterval(logoInterval); logoInterval=null; }
      if(logoAnimRAF){ cancelAnimationFrame(logoAnimRAF); logoAnimRAF=null; }
      if(logoOverlay){ document.body.removeChild(logoOverlay); logoOverlay=null; }
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      const logo=document.getElementById('logo');
      if(logo){ logo.style.cursor='pointer'; logo.addEventListener('mouseenter',startLogoAnimation); logo.addEventListener('mouseleave',stopLogoAnimation);
        logo.addEventListener('click',()=>{ currentSection='home'; fetchFolder(''); });
      }
      document.getElementById('nav-projects')?.addEventListener('click',()=>{ currentSection='projects'; fetchFolder('/Projects'); });
      document.getElementById('nav-about')?.addEventListener('click',()=>{ currentSection='about'; fetchFolder(''); });
      preloadLogoGallery();
      fetchFolder('');
    });

    async function preloadLogoGallery(){
      try{
        const url = `https://cloud-api.yandex.net/v1/disk/public/resources?public_key=${encodeURIComponent(MAIN_KEY)}&path=${encodeURIComponent(LOGO_CONTENT_PATH)}&preview_size=XL&preview_crop=true&limit=1000`;
        const data = await getJson(url);
        galleryImages = (data._embedded?.items||[])
          .filter(it=>it.type!=='dir' && it.preview)
          .map(it=>it.preview)
          .slice(0,50);
      }catch(e){ /* тихо игнорим */ }
    }
  </script>

  <footer class="fixed bottom-2 left-2 text-base text-gray-500 select-none">
    <div class="flex flex-col space-y-0" style="line-height:0.8">
      <span style="line-height:0.8">sapozhkov.george@gmail.com</span>
      <span style="line-height:0.8">@georgiisapozhkov</span>
    </div>
  </footer>
</body>
</html>
